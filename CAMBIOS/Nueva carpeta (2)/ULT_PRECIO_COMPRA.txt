USE [MARKET_CELESTE]
GO
/****** Object:  UserDefinedFunction [dbo].[ULT_PRECIO_COMPRA]    Script Date: 08/21/2019 10:32:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER FUNCTION [dbo].[ULT_PRECIO_COMPRA]
	(@FECHA CHAR(8),
	@COD_ART CHAR(15)
	 
	 )
RETURNS NUMERIC(18,4)
BEGIN 
	DECLARE @PU NUMERIC(18,4)
	
	SET @PU=0
	
	--AVERIGUAMOS SI ES COMBO
	IF (SELECT COUNT(COD_ART) FROM ARTICULOS WHERE COD_ART=@COD_ART AND COMBO_ART=1)=0
		BEGIN
			SELECT TOP 1 @PU=CASE WHEN INC_COMPRA=0 THEN PU_DC*(1+(CONVERT(FLOAT,VAL_IGV)/100)) ELSE
			PU_DC END
			FROM COMPRAS INNER JOIN
			Detalle_Compras ON COMPRAS.ID_COMPRA = Detalle_Compras.ID_COMPRA
			WHERE (Detalle_Compras.cod_art = @COD_ART) AND (COMPRAS.STAT_COMPRA = 0)
			AND FECHA_COMPRA<=@FECHA
			ORDER BY FECHA_COMPRA DESC							
		END
	ELSE
		BEGIN
			DECLARE @CA CHAR(15)
			DECLARE @CUR_ART CHAR(15)
			DECLARE @CUR_CANT FLOAT
			DECLARE @TOT NUMERIC(18,4)
			SET @TOT=0
			
			DECLARE CUR CURSOR FOR   
			SELECT	COD_ARTC,CANT_COMBO FROM Combos WHERE COD_ART=@COD_ART 
			OPEN CUR
			FETCH NEXT FROM CUR	INTO @CUR_ART,@CUR_CANT
			WHILE @@FETCH_STATUS = 0  
				BEGIN  
					SET @PU=0
					SELECT TOP 1 @PU=CASE WHEN INC_COMPRA=0 THEN PU_DC*(1+(CONVERT(FLOAT,VAL_IGV)/100)) ELSE
					PU_DC END
					FROM COMPRAS INNER JOIN
					Detalle_Compras ON COMPRAS.ID_COMPRA = Detalle_Compras.ID_COMPRA
					WHERE (Detalle_Compras.cod_art = @CUR_ART) AND (COMPRAS.STAT_COMPRA = 0)
					AND FECHA_COMPRA<=@FECHA
					ORDER BY FECHA_COMPRA DESC									
					
					SET @TOT=@TOT+(@CUR_CANT*ISNULL(@PU,0.0000))
					
					FETCH NEXT FROM CUR	INTO @CUR_ART,@CUR_CANT
				END
			SET @PU=@TOT
			CLOSE CUR
			DEALLOCATE CUR
		END

				
	RETURN ISNULL(@PU,0.0000)
END





