USE [MARKET_CELESTE]
GO
/****** Object:  StoredProcedure [dbo].[CONSULTAR_CUADRO_REPORTE]    Script Date: 01/22/2019 16:43:10 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[CONSULTAR_CUADRO_REPORTE]

	@FI CHAR(10),@FF CHAR(10),@AARTCODI NVARCHAR(8)

  AS

BEGIN
	DECLARE @CAD VARCHAR(MAX)

	SET @CAD="SELECT     VENTACAB.FECPROCESO as Fecha, ARTICULOS.DESC_ART as Articulo,ROUND(SUM(VENTADET.cantidad * (PRECIO - PRECIO * ISNULL(DSCTO_PORC, 0) 
                      / 100)) / SUM(VENTADET.cantidad), 4) 
                      AS 'PR Promedio Dia',
                      dbo.ULT_PRECIO_COMPRA(CONVERT(CHAR(8), VENTACAB.FECPROCESO, 112), VENTADET.COD_ART) AS 'PR Compra',
ROUND(SUM(VENTADET.cantidad * (PRECIO - PRECIO * ISNULL(DSCTO_PORC, 0) 
                      / 100)) / SUM(VENTADET.cantidad), 4) - dbo.ULT_PRECIO_COMPRA(CONVERT(CHAR(8), VENTACAB.FECPROCESO, 112), VENTADET.COD_ART) AS Margen,
                      ROUND(SUM(VENTADET.cantidad), 2) AS 'Vnta Cant',
                      
(ROUND(SUM(VENTADET.cantidad * (PRECIO - PRECIO * ISNULL(DSCTO_PORC, 0) 
                      / 100)) / SUM(VENTADET.cantidad), 4) -dbo.ULT_PRECIO_COMPRA(CONVERT(CHAR(8), VENTACAB.FECPROCESO, 112), VENTADET.COD_ART)) 
                      * ROUND(SUM(VENTADET.cantidad), 2) AS 'Ganancia Incluido Impuesto',    

 (ROUND(SUM(VENTADET.cantidad * (PRECIO - PRECIO * ISNULL(DSCTO_PORC, 0) 
                      / 100)) / SUM(VENTADET.cantidad), 4) -dbo.ULT_PRECIO_COMPRA(CONVERT(CHAR(8), VENTACAB.FECPROCESO, 112), VENTADET.COD_ART)) 
                      * ROUND(SUM(VENTADET.cantidad), 2)
                      / (1 + CONVERT(FLOAT,VENTACAB.VAL_IGV) / 100) AS 'Ganancia Sin Igv'
FROM         VENTACAB INNER JOIN
                      VENTADET ON VENTACAB.COD_DOC = VENTADET.COD_DOC AND VENTACAB.NRODOCU = VENTADET.NRODOCU INNER JOIN
                      ARTICULOS ON VENTADET.COD_ART = ARTICULOS.COD_ART
                   
	
WHERE     (VENTACAB.STAT_VENTA = 0) AND (VENTACAB.FECPROCESO BETWEEN '"+@FI+"' AND '"+@FF+"') "

IF @AARTCODI<>'' SET @CAD=@CAD+" AND VENTADET.COD_ART='"+@AARTCODI+"'"

SET @CAD=@CAD+"  group by VENTACAB.FECPROCESO, ARTICULOS.DESC_ART,VENTADET.COD_ART,VENTACAB.VAL_IGV
ORDER BY VENTACAB.FECPROCESO "

PRINT @CAD
EXEC(@CAD)

END



