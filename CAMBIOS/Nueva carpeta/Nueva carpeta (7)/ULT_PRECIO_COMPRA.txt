
/****** Object:  UserDefinedFunction [dbo].[ULT_PRECIO_COMPRA]    Script Date: 10/29/2018 13:58:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE FUNCTION [dbo].[ULT_PRECIO_COMPRA]
	(@FECHA CHAR(8),
	@COD_ART CHAR(15)
	 
	 )
RETURNS NUMERIC(18,4)
BEGIN 
	DECLARE @PU NUMERIC(18,4)
	
	SET @PU=0
	
	SELECT TOP 1 @PU=CASE WHEN INC_COMPRA=0 THEN PU_DC*(1+(CONVERT(FLOAT,VAL_IGV)/100)) ELSE
	PU_DC END
	FROM COMPRAS INNER JOIN
    Detalle_Compras ON COMPRAS.ID_COMPRA = Detalle_Compras.ID_COMPRA
	WHERE (Detalle_Compras.cod_art = @COD_ART) AND (COMPRAS.STAT_COMPRA = 0)
	AND FECHA_COMPRA<=@FECHA
	ORDER BY FECHA_COMPRA DESC							
				
	RETURN ISNULL(@PU,0.0000)
END





