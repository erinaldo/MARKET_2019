USE [MARKET_CELESTE]
GO
/****** Object:  StoredProcedure [dbo].[LISTAR_PRODUCTOS]    Script Date: 03/07/2019 10:09:28 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[LISTAR_PRODUCTOS]

	@CADENA VARCHAR(250),

	@CAMPO VARCHAR(250),

	@COD_FAMILIA VARCHAR(3),

	@COD_GRUPO VARCHAR(3),

	@VER_SOLO_STOCK INT,

	@SW INT

  AS

BEGIN

	DECLARE @CAD VARCHAR(8000)

	DECLARE @CAD2 VARCHAR(2500)

	

	SET @CAD="SELECT ARTICULOS.COD_ART as Cod, ARTICULOS.COD_ART AS Cod2, ARTICULOS.DESC_ART as Descripcion, '' AS Marca, "+

	" MEDIDA.DESC_MEDIDA as Medida,'S' AS Mon, "+

    " (SELECT SUM(CASE tipo_mov WHEN 'Ingreso' THEN cant_KARDEX ELSE 0 END) - SUM(CASE tipo_mov WHEN 'Salida' THEN cant_KARDEX ELSE 0 END) "+

    " FROM Kardex WHERE (codigo = ARTICULOS.COD_ART)) AS Stock,ISNULL(stock_MIN,0) AS StkMin,convert(numeric(18,4), ARTICULOS.COSTO_ART) as Costo, "+

    " CASE WHEN STAT_art <> '' THEN 'ANULADO' ELSE '' END AS Estado "+

	" FROM ARTICULOS INNER JOIN MEDIDA ON ARTICULOS.COD_MEDIDA = MEDIDA.COD_MEDIDA "+

    " WHERE  (dbo.articulos.STAT_ART <> 3) "

                       

	--CAMPO A BUSCAR

	IF @CADENA<>'' SET @CAD=@CAD+" AND "+@CAMPO+" LIKE '%"+@CADENA+"%'" 



	IF @COD_FAMILIA<>'' SET @CAD=@CAD+" AND ARTICULOS.COD_FAMILIA='"+@COD_FAMILIA+"'" 

	IF @COD_GRUPO<>'' SET @CAD=@CAD+" AND ARTICULOS.COD_GRUPO='"+@COD_GRUPO+"'" 

	--IF @COD_MARCA<>'' SET @CAD=@CAD+" AND PRODUCTOS.COD_MARCA='"+@COD_MARCA+"'" 

	

	--IF @VER_SOLO_STOCK=1 SET @CAD=@CAD+" AND DBO.STOCK_TOTAL(PRODUCTOS.COD_PROD)>0" 

	IF @VER_SOLO_STOCK=1 SET @CAD=@CAD+" AND ("+

    " SELECT SUM(CASE tipo_mov WHEN 'Ingreso' THEN cant_KARDEX ELSE 0 END) - SUM(CASE tipo_mov WHEN 'Salida' THEN cant_KARDEX ELSE 0 END) "+

    " FROM Kardex WHERE (codigo = ARTICULOS.COD_ART))>0 "



	IF @SW<>2  SET @CAD=@CAD+"AND STAT_ART="+CONVERT(CHAR(1),@SW)+""



	SET @CAD=@CAD+" ORDER BY DESC_ART ASC"



	PRINT @CAD

	EXEC(@CAD)

END


