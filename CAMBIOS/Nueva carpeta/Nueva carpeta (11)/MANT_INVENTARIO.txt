USE [MARKET_CELESTE]
GO

/****** Object:  StoredProcedure [dbo].[MANT_ALMACENES]    Script Date: 01/02/2019 11:36:54 ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO




CREATE PROC [dbo].[MANT_INVENTARIO]
(@COD_INV	bigint,
 @FECHA_INV	datetime,
 @COD_ALMACEN	bigint,
 @OBSERV_INV	varchar(2500),
 @COD_USER	varchar(10),
 @TIP CHAR(1), --N-NUEVO , M-MODIFICAR, A-ANULAR
 @ingproc_001	 	int output
)

AS
BEGIN
	BEGIN TRAN	
	set @ingproc_001=0
	
	DECLARE @COD_SAL BIGINT
	SET @COD_SAL=@COD_INV
	
	IF @TIP='N'
		BEGIN
			INSERT INTO INVENTARIO(FECHA_INV,COD_ALMACEN,OBSERV_INV,STAT_INV,FECHA_REG,COD_USER) 
			VALUES(@FECHA_INV,@COD_ALMACEN,@OBSERV_INV,0,GETDATE(),@COD_USER)
			SET @COD_SAL=@@IDENTITY
		END

	IF @TIP='M'
		BEGIN
			UPDATE INVENTARIO SET 
			FECHA_INV=@FECHA_INV,
			COD_ALMACEN=@COD_ALMACEN,
			OBSERV_INV=@OBSERV_INV,
			FECHA_REG=GETDATE(),
			COD_USER=@COD_USER
			WHERE COD_INV=@COD_INV
			
			DELETE FROM INVENTARIOD WHERE COD_INV=@COD_INV
			DELETE FROM KARDEX WHERE TIPO_COMP='Inventario' and ID_DOC=@COD_INV
		END

	IF @TIP='A'
		BEGIN
			UPDATE INVENTARIO SET STAT_INV=1 WHERE COD_INV=@COD_INV
			DELETE FROM KARDEX WHERE TIPO_COMP='Inventario' and ID_DOC=@COD_INV
			GOTO IR
		END

	--GRABAMOS EL DETALLE
	INSERT INTO INVENTARIOD(COD_INV,ITEM_INVD,COD_ART,COSTO_ART,STOCK_INVD,CANT_INVD)
	SELECT @COD_SAL,ITEM,COD_ART,COSTO_ART, STOCK_ART, CANT_ART
	FROM TEMP_INVENTARIO WHERE (COD_USER = @COD_USER) ORDER BY ITEM
	
	--GRABAMOS EN EL KARDEX
	DECLARE @CUR_ART CHAR(15) 
	DECLARE @CUR_DIF FLOAT
	DECLARE @TIPO_MOV VARCHAR(30)
	DECLARE @CUR_COSTO FLOAT
	
	Declare CUR Cursor For 
	SELECT COD_ART,ISNULL(STOCK_ART,0)-ISNULL(CANT_ART,0),ISNULL(COSTO_ART,0) FROM TEMP_INVENTARIO WHERE COD_USER=@COD_USER
    OPEN CUR
    FETCH NEXT FROM CUR INTO @CUR_ART,@CUR_DIF,@CUR_COSTO
    WHILE @@FETCH_STATUS =0
		BEGIN

			IF @CUR_DIF>=0 SET @TIPO_MOV='Ingreso'
			IF @CUR_DIF<0 SET @TIPO_MOV='Salida'
			EXEC AGREGAR_KARDEX @CUR_ART,@CUR_DIF,@FECHA_INV,'Inventario',@COD_SAL,@TIPO_MOV,@OBSERV_INV,'S',@CUR_COSTO,@COD_USER,3.3,
			@COD_ALMACEN

			FETCH NEXT FROM CUR INTO @CUR_ART,@CUR_DIF,@CUR_COSTO
		END
	CLOSE CUR
	DEALLOCATE CUR


	IF (@@error!=0)
    	BEGIN
			set @ingproc_001=1
			--RAISERROR 20000 'Error insertando Familia'
			ROLLBACK  TRAN
      		RETURN(1)
    	END
IR:
	COMMIT TRAN
	RETURN(0)
END



GO


