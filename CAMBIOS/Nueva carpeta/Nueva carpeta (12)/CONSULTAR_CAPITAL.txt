USE [MARKET_CELESTE]
GO
/****** Object:  StoredProcedure [dbo].[CONSULTAR_CAPITAL]    Script Date: 01/18/2019 15:24:31 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[CONSULTAR_CAPITAL]
	@FECHA_CAPITAL CHAR(8),
	@CAJA FLOAT OUTPUT,
	@XCOBRAR FLOAT OUTPUT,@XPAGAR FLOAT OUTPUT,@INV_VAL FLOAT OUTPUT,
	@BANCOS FLOAT OUTPUT
  AS
BEGIN
	--BANCOS
	EXEC CAPITAL_BANCO @FECHA_CAPITAL,@BANCOS OUTPUT 
	SET @BANCOS=ISNULL(@BANCOS,0)
	
	--CAJA
	SELECT @CAJA=SUM(CASE WHEN TIPO_MCAJA='I' THEN 
	(CASE WHEN MON_MCAJA='S' THEN MONTO_MCAJA ELSE MONTO_MCAJA*TC_MCAJA END)
	ELSE
	(CASE WHEN MON_MCAJA='S' THEN -1*MONTO_MCAJA ELSE -1*MONTO_MCAJA*TC_MCAJA END)
	END
	) FROM CAJA_OFICINA
	WHERE FECHA_MCAJA<=@FECHA_CAPITAL AND STAT_MCAJA=0
	SET @CAJA=ISNULL(@CAJA,0)
	
		
	--X COBRAR
	SELECT @XCOBRAR=SUM(CASE WHEN MON_CRED = 'S' THEN TOTAL_CRED ELSE TOTAL_CRED * VENTACAB.CAMBIO_VENTA END) -
	(SELECT ISNULL(SUM(CASE WHEN MON_COBRO='S' THEN TOTAL_COBRO ELSE TOTAL_COBRO *CAMBIO_COBRO END),0) FROM COBRANZAC
	WHERE STAT_COBRO=0 AND FECHA_COBRO<=@FECHA_CAPITAL)
	FROM VENTACRED INNER JOIN
    VENTACAB ON VENTACRED.COD_DOC = VENTACAB.COD_DOC AND VENTACRED.NRODOCU = VENTACAB.NRODOCU
	WHERE(VENTACAB.FECHA_VENTA <=@FECHA_CAPITAL) AND (VENTACAB.STAT_VENTA = 0)
	
	SET @XCOBRAR=ISNULL(@XCOBRAR,0)
	
	--X PAGAR
	SELECT @XPAGAR=SUM(CASE WHEN MON_COMPRA='S' THEN TOTAL_COMPRA ELSE TOTAL_COMPRA*TC_COMPRA END)-
	(SELECT ISNULL(SUM(CASE WHEN MON_PAGO='S' THEN monto_PAGO ELSE monto_PAGO*tc_PAGO END),0) FROM PAGOs
	WHERE FECHA_PAGO<=@FECHA_CAPITAL)
	FROM COMPRAS WHERE STAT_COMPRA=0 AND FECHA_COMPRA<=@FECHA_CAPITAL
	
	SET @XPAGAR=ISNULL(@XPAGAR,0)
	
	--INVENTARIO
	/*
	SELECT @inv_val=sum(CASE WHEN TIPO_MOV='Ingreso' then
	(case when mon_kardex='S' then cant_kardex*costo_kardex else cant_kardex*costo_kardex*tc_kardex end)
	else
	(case when mon_kardex='S' then -1*cant_kardex*costo_kardex else -1*cant_kardex*costo_kardex*tc_kardex end)
	end) 
	FROM KARDEX
	WHERE FECHA_KARDEX<=@FECHA_CAPITAL
	*/
	SELECT @INV_VAL=SUM(PC) FROM(
	SELECT SUM(CASE WHEN TIPO_MOV = 'Ingreso' THEN cant_kardex ELSE - 1 * cant_kardex END) * dbo.ULT_PRECIO_COMPRA(@FECHA_CAPITAL, codigo) AS PC,CODIGO
	FROM         Kardex
	WHERE    
	-- (FECHA_KARDEX <= @FECHA_CAPITAL)
	case when tipo_comp='Venta' then (select fecproceso from ventacab where cod_doc=left(id_doc,3) and nrodocu=right(id_doc,8)) else fecha_kardex end <= @FECHA_CAPITAL
	GROUP BY CODIGO)T

	SET @INV_VAL=ISNULL(@INV_VAL,0)
	
	
	
END


