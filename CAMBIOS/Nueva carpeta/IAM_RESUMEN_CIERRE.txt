
/****** Object:  StoredProcedure [dbo].[IAM_RESUMEN_CIERRE]    Script Date: 03/11/2018 16:56:51 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROC [dbo].[IAM_RESUMEN_CIERRE]
(
	@FECHA SMALLDATETIME,@COD_USER VARCHAR(10),@TURNO INT
)
AS
BEGIN
	DECLARE @MINFACT BIGINT
	DECLARE @MAXFACT BIGINT
	DECLARE @TOTFACT NUMERIC(13,3)
	
	DECLARE @MINBOL BIGINT
	DECLARE @MAXBOL BIGINT
	DECLARE @TOTBOL NUMERIC(13,3)
	
	DECLARE @ANULFACT FLOAT
	DECLARE @TOTANULFACT NUMERIC(13,3)
	DECLARE @ANULBOL FLOAT
	DECLARE @TOTANULBOL NUMERIC(13,3)
	
	DECLARE @SUBT NUMERIC(13,3)
	DECLARE @IGV NUMERIC(13,3)
	DECLARE @TOTAL NUMERIC(13,3)
	
	DECLARE @CANTFACT BIGINT
	DECLARE @CANTBOL BIGINT
	
	DECLARE @CANTTK INT
	DECLARE @TOTVTA NUMERIC(13,3)
	
		
	SELECT  @CANTTK=COUNT(NRODOCU),@TOTVTA=SUM(TOTAL_VENTA)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0
	
	SELECT  @MINFACT=MIN(NRODOCU),@MAXFACT=MAX(NRODOCU),@TOTFACT=SUM(TOTAL_VENTA)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0 AND COD_DOC='001'


	SELECT  @MINBOL=MIN(NRODOCU),@MAXBOL=MAX(NRODOCU),@TOTBOL=SUM(TOTAL_VENTA)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0 AND COD_DOC='002'
	

	SELECT @ANULFACT=COUNT(NRODOCU),@TOTANULFACT=SUM(TOTAL_VENTA)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=1 AND COD_DOC='001'


	SELECT @ANULBOL=COUNT(NRODOCU),@TOTANULBOL=SUM(TOTAL_VENTA)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=1 AND COD_DOC='002'
	
	SELECT @SUBT=ROUND( SUM(SUBTOT_VENTA),2), 
	@IGV=ROUND(SUM(IGV_VENTA),2) ,
	@TOTAL=ROUND(SUM(TOTAL_VENTA),2)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0


	SELECT @CANTFACT=COUNT(NRODOCU)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0 AND COD_DOC='001'


	SELECT @CANTBOL=COUNT(NRODOCU)
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0 AND COD_DOC='002'
	
	--VENTA EFECTIVO
	DECLARE @VTAEFECT NUMERIC(13,3) 
	SELECT @VTAEFECT=SUM(PAGOS_VENTA+PAGOD_VENTA*CAMBIO_VENTA) 
	FROM VENTACAB
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0 
	
	--VENTA TARJETAS
	DECLARE @VTATARJ NUMERIC(13,3) 
	SELECT @VTATARJ=SUM(CASE WHEN MON_TARJETA='S' THEN VENTATARJ.MONTO_TARJETA ELSE VENTATARJ.MONTO_TARJETA*CAMBIO_VENTA END)
	FROM VENTACAB INNER JOIN
    VENTATARJ ON VENTACAB.COD_DOC = VENTATARJ.COD_DOC AND VENTACAB.NRODOCU = VENTATARJ.NRODOCU
	WHERE FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0 
	
	--ORDENES
	DECLARE @ORDENES NUMERIC(13,3)
	SELECT @ORDENES=SUM(VENTACAB.TOTAL_VENTA)
	FROM VENTACAB INNER JOIN
    VENTACRED ON VENTACAB.COD_DOC = VENTACRED.COD_DOC AND VENTACAB.NRODOCU = VENTACRED.NRODOCU
	WHERE VENTACAB.FECPROCESO=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	AND STAT_VENTA=0 	
	
	--DEPOSITOS
	DECLARE @DEPOSITOS NUMERIC(13,3)
	SELECT @DEPOSITOS=SUM(CASE WHEN TIPOMOVI='S' THEN -1*MONTO_CAJA ELSE MONTO_CAJA END)
	FROM MOVICAJA
	WHERE (TRANSF_CAJA = 1) AND FECHA_CAJA=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	
	--PAGO CAJA
	DECLARE @PAGO_CAJA NUMERIC(13,3)
	SELECT @PAGO_CAJA=SUM(CASE WHEN TIPOMOVI='S' THEN -1*MONTO_CAJA ELSE MONTO_CAJA END)
	FROM MOVICAJA
	WHERE (TRANSF_CAJA = 0) AND FECHA_CAJA=@FECHA AND COD_USER=@COD_USER AND TURNO=@TURNO
	
	SELECT ISNULL(@MINFACT,0) AS MINFACT,ISNULL(@MAXFACT,0) AS MAXFACT,ISNULL(@TOTFACT,0) AS TOTFACT,
	ISNULL(@MINBOL,0) AS MINBOL,ISNULL(@MAXBOL,0) AS MAXBOL,ISNULL(@TOTBOL,0) AS TOTBOL,
	ISNULL(@ANULFACT,0) AS ANULFACT,ISNULL(@TOTANULFACT,0) AS TOTANULFACT,ISNULL(@ANULBOL,0) AS ANULBOL,
	ISNULL(@TOTANULBOL,0) AS TOTANULBOL,ISNULL(@SUBT,0) AS SUBT,ISNULL(@IGV,0) AS IGV,ISNULL(@TOTAL,0) AS TOTAL,
	ISNULL(@CANTFACT,0) AS CANTFACT,ISNULL(@CANTBOL,0) AS CANTBOL,
	ISNULL(@CANTTK,0) AS CANTTK,ISNULL(@TOTVTA,0) AS TOTVTA,
	ISNULL(@VTAEFECT,0) AS VTAEFECT,
	ISNULL(@VTATARJ,0) AS VTATARJ,
	ISNULL(@ORDENES,0) AS ORDENES,
	ISNULL(@DEPOSITOS,0) AS DEPOSITOS,
	ISNULL(@PAGO_CAJA,0) AS PAGO_CAJA
	--ISNULL(@NOMB_USER,'') AS NOMB_USER,
	--@FECHAPROG AS FECHAPROG,
	--@TURNO AS TURNO
	
END
