USE [MARKET]
GO
/****** Object:  StoredProcedure [dbo].[MANT_PTOVTA]    Script Date: 05/01/2018 13:11:36 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
ALTER PROC [dbo].[MANT_PTOVTA]
( @APTOCODI	nvarchar(8),
	@APTOEDIT	bit,
	@APTOFEPO	smalldatetime,
	@APTOTERM	nvarchar(30),
	@APTOSTAT BIT,
	@APTOREG    VARCHAR(15),
	@COD_ALMACEN BIGINT,
  @TIP			CHAR(1), --N-NUEVO , M-MODIFICAR, A-ANULAR
 @ingproc_001	 	int output
)
AS
BEGIN
	BEGIN TRAN	

	set @ingproc_001=0

	IF @TIP='N'
		BEGIN
			IF (SELECT COUNT(APTOCODI) FROM PTOVTA WHERE APTOCODI=@APTOCODI )>0
				BEGIN
					SET @INGPROC_001=2
					GOTO IR				
				END

			INSERT INTO PTOVTA(APTOCODI,APTOEDIT,APTOFEPO,APTOTERM,	APTOSTAT,APTOREG,COD_ALMACEN) 
			VALUES(@APTOCODI,@APTOEDIT,@APTOFEPO,@APTOTERM,@APTOSTAT,@APTOREG,@COD_ALMACEN)
		END

	IF @TIP='M'
		BEGIN
			UPDATE PTOVTA SET APTOEDIT=@APTOEDIT,APTOFEPO=@APTOFEPO,APTOTERM=@APTOTERM,APTOSTAT=@APTOSTAT,
			APTOREG=@APTOREG,
			COD_ALMACEN=@COD_ALMACEN 
			WHERE APTOCODI=@APTOCODI
			DELETE FROM PTOVTAD WHERE APTOCODI=@APTOCODI
		END

	IF @TIP='A'
		BEGIN
			UPDATE PTOVTA SET APTOSTAT=1 WHERE APTOCODI=@APTOCODI
		END

	IF (@@error!=0)
    	BEGIN
		set @ingproc_001=1
		RAISERROR 20000 'Error insertando Familia'
		ROLLBACK  TRAN
      		RETURN(1)
    	END

IR:
	COMMIT TRAN
	RETURN(0)
END