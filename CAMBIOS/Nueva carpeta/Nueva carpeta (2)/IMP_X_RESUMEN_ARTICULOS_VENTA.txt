USE [MARKET]
GO
/****** Object:  StoredProcedure [dbo].[IMP_X_RESUMEN_ARTICULOS_VENTA]    Script Date: 05/01/2018 15:45:18 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
ALTER PROCEDURE [dbo].[IMP_X_RESUMEN_ARTICULOS_VENTA]
@FECHA SMALLDATETIME,@PTOVTA VARCHAR(30),@TURNO INT
AS




SELECT     dbo.VENTADET.COD_ART, dbo.ARTICULOS.DESC_ART, 
--SUM(dbo.VENTADET.CANTIDAD * dbo.VENTADET.PRECIO-(
--CASE WHEN ISNULL(DSCTO_PORC, 0) 
  --                    <> 0 THEN PRECIO * ISNULL(DSCTO_PORC / 100, 0) ELSE (CASE WHEN ISNULL(DSCTO_MONTO,0)<>0 THEN  ISNULL(DSCTO_MONTO, 0) ELSE 0 END) END)
--) AS TOTAL
SUM(CANTIDAD*(precio-precio*isnull(dscto_porc,0)/100)) AS TOTAL
FROM         dbo.VENTACAB INNER JOIN
                      dbo.VENTADET ON dbo.VENTACAB.COD_DOC = dbo.VENTADET.COD_DOC AND dbo.VENTACAB.NRODOCU = dbo.VENTADET.NRODOCU INNER JOIN
                      dbo.ARTICULOS ON dbo.VENTADET.COD_ART = dbo.ARTICULOS.COD_ART LEFT OUTER JOIN
                      dbo.PTOVTA ON dbo.VENTACAB.NROPTOVTA = dbo.PTOVTA.APTOTERM
GROUP BY dbo.VENTACAB.FECPROCESO, dbo.PTOVTA.APTOCODI, dbo.VENTADET.COD_ART, dbo.VENTACAB.STAT_VENTA, dbo.ARTICULOS.DESC_ART, 
                      dbo.VENTACAB.TURNO
HAVING      (TURNO = @TURNO) AND (FECPROCESO = @FECHA) AND (PTOVTA.APTOCODI = @PTOVTA) AND (dbo.VENTACAB.STAT_VENTA = 0)