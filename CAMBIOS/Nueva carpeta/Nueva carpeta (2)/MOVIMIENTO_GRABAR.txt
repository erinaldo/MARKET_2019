USE [MARKET]
GO
/****** Object:  StoredProcedure [dbo].[MOVIMIENTO_GRABAR]    Script Date: 04/30/2018 14:35:09 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
ALTER PROCEDURE [dbo].[MOVIMIENTO_GRABAR]
@COD_MOV	char(6),
@TIPO_MOV	char(1),
@COD_TMOV	char(2),
@FECHA_MOV	datetime,
@MON_MOV	char(1),
@TC_MOV FLOAT,
@OBS_MOV	varchar(1500),
@TOTAL_MOV	float,
@COD_USER	varchar(10),
@COD_ALMACEN	bigint,
@ALM_DESTINO	bigint,
@TIPO CHAR(1),
@ingproc_001	 	INT output

AS
BEGIN
	DECLARE @MOV VARCHAR(25)
	DECLARE @ALM_DEST BIGINT
	
	BEGIN TRAN	

	set @ingproc_001=0

	IF @TIPO='N'
		BEGIN
			--BUSCAR SI EXISTE
			IF (SELECT COUNT(COD_MOV) FROM MOVIMIENTOS WHERE COD_MOV=@COD_MOV AND TIPO_MOV=@TIPO_MOV) >0 
				BEGIN
					set @ingproc_001=2
					GOTO FINAL
				END
			
			INSERT INTO MOVIMIENTOS(COD_MOV,TIPO_MOV,COD_TMOV,FECHA_MOV,MON_MOV,TC_MOV,OBS_MOV,TOTAL_MOV,STAT_MOV,
			FECHA_REG,COD_USER,COD_ALMACEN,ALM_DESTINO) VALUES
			(@COD_MOV,@TIPO_MOV,@COD_TMOV,CONVERT(VARCHAR,@fecha_MOV,103),@MON_MOV,@TC_MOV,
			@OBS_MOV,@TOTAL_MOV,0,GETDATE(),@COD_USER,@COD_ALMACEN,@ALM_DESTINO)
				
			GOTO FINAL
			--PRINT @ID
			
		END
	ELSE
		BEGIN
		
			UPDATE MOVIMIENTOS SET				
			cod_TMOV=@COD_TMOV,
			FECHA_MOV=CONVERT(VARCHAR,@fecha_MOV,103),
			MON_MOV=@MON_MOV,
			TC_MOV=@TC_MOV,
			OBS_MOV=@OBS_MOV,
			TOTAL_MOV=@TOTAL_MOV,
			COD_USER=@COD_USER,
			FECHA_REG=GETDATE(),
			COD_ALMACEN=@COD_ALMACEN,
			ALM_DESTINO=@ALM_DESTINO
			WHERE COD_MOV=@COD_MOV AND TIPO_MOV=@TIPO_MOV

			--ELIMINAMOS DETALLE
			DELETE MOVIMIENTOS_DETALLE WHERE COD_MOV=@COD_MOV AND TIPO_MOV=@TIPO_MOV
			--ELIMINAMOS DEL KARDEX
			IF @TIPO_MOV='I' SET @MOV='Movimiento_I' 
			IF @TIPO_MOV='S' SET @MOV='Movimiento_S'
			DELETE KARDEX WHERE TIPO_COMP=@MOV and ID_DOC=@COD_MOV
			--AVERIGUAMOS SI ES DE TRANSFERENCIA
			SELECT @ALM_DEST=ALM_DESTINO FROM MOVIMIENTOS WHERE TIPO_MOV=@TIPO_MOV AND COD_MOV=@COD_MOV 
			IF ISNULL(@ALM_DEST,0) <>0 
				BEGIN
					DELETE KARDEX WHERE TIPO_MOV='Ingreso' AND TIPO_COMP='Movimiento_I' AND ID_DOC=@COD_MOV 
				END
		--
		END
	
IF (@@error!=0)
   		BEGIN
			set @ingproc_001=1
			RAISERROR 20000 'Error insertando Familia'
			ROLLBACK  TRAN
     			RETURN(1)
	    	END



	


FINAL:
	COMMIT TRAN

END