USE [MARKET]
GO
/****** Object:  StoredProcedure [dbo].[MOVIMIENTO_ANULAR]    Script Date: 05/01/2018 11:44:42 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[MOVIMIENTO_ANULAR]
@COD_MOV CHAR(6),@TIPO_MOV CHAR(1),@COD_USER VARCHAR(10),@SW INT OUTPUT
 AS
	DECLARE @COD_ART CHAR(15),
		@CANT_DC FLOAT,
		@MONEDA CHAR(1),
		@PU FLOAT,
		@TC FLOAT,
		@FECHA DATETIME,
		@MOV VARCHAR(25),
		@TMOV VARCHAR(25)
SET @SW=0

DECLARE @ALM_DEST BIGINT

IF @TIPO_MOV='I' 
	BEGIN		
		 SET @MOV='Movimiento_I'
		 SET @TMOV='Ingreso'
	END
ELSE
	BEGIN
		SET @MOV='Movimiento_S'
		SET @TMOV='Salida'
	END
	
DELETE KARDEX WHERE TIPO_MOV=@TMOV AND TIPO_COMP=@MOV AND ID_DOC=@COD_MOV 
--AVERIGUAMOS SI ES DE TRANSFERENCIA
SELECT @ALM_DEST=ALM_DESTINO FROM MOVIMIENTOS WHERE TIPO_MOV=@TIPO_MOV AND COD_MOV=@COD_MOV 
	IF ISNULL(@ALM_DEST,0) <>0 
		BEGIN
			DELETE KARDEX WHERE TIPO_MOV='Ingreso' AND TIPO_COMP='Movimiento_I' AND ID_DOC=@COD_MOV 
		END
--
/*
--ANULAMOS DEL KARDEX
 DECLARE CUR_TMP INSENSITIVE CURSOR
 FOR
 SELECT     MOVIMIENTOS_DETALLE.COD_ART, MOVIMIENTOS_DETALLE.CANT_DM, MOVIMIENTOS.MON_MOV, MOVIMIENTOS_DETALLE.PU_DM, 
                      MOVIMIENTOS.TC_MOV
FROM         MOVIMIENTOS INNER JOIN
                      MOVIMIENTOS_DETALLE ON MOVIMIENTOS.COD_MOV = MOVIMIENTOS_DETALLE.COD_MOV AND 
                      MOVIMIENTOS.TIPO_MOV = MOVIMIENTOS_DETALLE.TIPO_MOV WHERE MOVIMIENTOS.COD_MOV=@COD_MOV AND MOVIMIENTOS.TIPO_MOV=@TIPO_MOV
   OPEN CUR_TMP
   FETCH NEXT FROM CUR_TMP INTO @COD_ART,@CANT_DC,@MONEDA,@PU,@TC

 WHILE @@FETCH_STATUS =0
	 BEGIN	       
		set @FECHA=CONVERT(VARCHAR,GETDATE(),103)

		EXEC AGREGAR_KARDEX @COD_ART,@CANT_DC,@FECHA,@MOV,@COD_MOV,@TMOV,'Anulacion',@MONEDA,@PU,@COD_USER,@TC

		FETCH NEXT FROM CUR_TMP INTO @COD_ART,@CANT_DC,@MONEDA,@PU,@TC
	END
     CLOSE CUR_TMP
     DEALLOCATE CUR_TMP
*/
UPDATE MOVIMIENTOS SET STAT_MOV=1,COD_USER=@COD_USER,FECHA_REG=GETDATE() WHERE COD_MOV=@COD_MOV AND TIPO_MOV=@TIPO_MOV






IF @@ERROR<>0
	BEGIN
		SET @SW=1
	END
RETURN