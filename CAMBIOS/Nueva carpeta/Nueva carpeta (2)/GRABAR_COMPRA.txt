USE [MARKET]
GO
/****** Object:  StoredProcedure [dbo].[GRABAR_COMPRA]    Script Date: 05/01/2018 12:01:55 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GRABAR_COMPRA]
@ID_COMPRA INT,
@cod_doc	char(3),
@serie_COMPRA	varchar(	5),
@num_COMPRA	varchar(	12),
@fecha_COMPRA	datetime,
@VENC_COMPRA	datetime,
@COD_PROVED	char(20),
@MON_COMPRA	char(1),
@TC_COMPRA	FLOAT,
@INC_COMPRA	bit,
@COD_FP	char(3),
@SUBT_COMPRA	float,
@IGV_COMPRA	float,
@TOTAL_COMPRA	float,
@COD_USER	varchar(10),
@OBS_COMPRA	varchar(1200),
@COD_ALMACEN BIGINT,
@TIPO CHAR(1),
@ID	 	FLOAT output,
@ingproc_001	 	INT output
 AS
BEGIN
	BEGIN TRAN	

	--IGV
	DECLARE @VAL_IGV INT
	SELECT @VAL_IGV=IGV FROM CONFIG
	SET @VAL_IGV=ISNULL(@VAL_IGV,0)
	--
	set @ingproc_001=0

	IF @TIPO='N'
		BEGIN
			SET @ID=0
			--BUSCAR SI EXISTE
			IF (SELECT COUNT(NUM_COMPRA) FROM COMPRAS WHERE COD_DOC=@COD_DOC AND SERIE_COMPRA=@SERIE_COMPRA AND NUM_COMPRA=@NUM_COMPRA AND COD_PROVED=@COD_PROVED) >0 
				BEGIN
					set @ingproc_001=2
					--ROLLBACK  TRAN
					GOTO FINAL
				END
			
			INSERT INTO COMPRAS(cod_doc,serie_COMPRA,num_COMPRA,fecha_COMPRA,VENC_COMPRA,COD_PROVED,MON_COMPRA,TC_COMPRA,INC_COMPRA,COD_FP,
			SUBT_COMPRA,IGV_COMPRA,TOTAL_COMPRA,COD_USER,FECHA_REG,OBS_COMPRA,STAT_COMPRA,VAL_IGV,COD_ALMACEN) VALUES
			(@cod_doc,@serie_COMPRA,@num_COMPRA,CONVERT(VARCHAR,@fecha_COMPRA,103),CONVERT(VARCHAR,@VENC_COMPRA,103),@COD_PROVED,@MON_COMPRA,@TC_COMPRA,
			@INC_COMPRA,@COD_FP,@SUBT_COMPRA,@IGV_COMPRA,@TOTAL_COMPRA,@COD_USER,GETDATE(),@OBS_COMPRA,0,@VAL_IGV,@COD_ALMACEN)
				
			SET @ID=@@IDENTITY 
			GOTO FINAL
			--PRINT @ID
			
		END
	ELSE
		BEGIN
			SET @ID=@ID_COMPRA
			--BUSCAR SI EXISTE
			IF (SELECT COUNT(NUM_COMPRA) FROM COMPRAS WHERE COD_DOC=@COD_DOC AND SERIE_COMPRA=@SERIE_COMPRA AND NUM_COMPRA=@NUM_COMPRA AND COD_PROVED=@COD_PROVED AND ID_COMPRA<>ID_COMPRA) >0 
				BEGIN
					set @ingproc_001=2
					ROLLBACK  TRAN
					RETURN (1)
				END
		
			UPDATE COMPRAS SET				
			cod_doc=@COD_DOC,
			SERIE_COMPRA=@serie_COMPRA,
			NUM_COMPRA=@num_COMPRA,
			FECHA_COMPRA=CONVERT(VARCHAR,@fecha_COMPRA,103),
			VENC_COMPRA=CONVERT(VARCHAR,@VENC_COMPRA,103),
			COD_PROVED=@COD_PROVED,
			MON_COMPRA=@MON_COMPRA,
			TC_COMPRA=@TC_COMPRA,
			INC_COMPRA=@INC_COMPRA,
			COD_FP=@COD_FP,
			SUBT_COMPRA=@SUBT_COMPRA,
			IGV_COMPRA=@IGV_COMPRA,
			TOTAL_COMPRA=@TOTAL_COMPRA,
			COD_USER=@COD_USER,
			FECHA_REG=GETDATE(),
			OBS_COMPRA=@OBS_COMPRA,
			COD_ALMACEN=@COD_ALMACEN
			WHERE ID_COMPRA=@ID_COMPRA

			--ELIMINAMOS DETALLE
			DELETE DETALLE_COMPRAS WHERE ID_COMPRA=@ID_COMPRA
			--ELIMINAMOS DEL KARDEX
			DELETE KARDEX WHERE TIPO_COMP='Compra' and ID_DOC=@ID_COMPRA

		END
	
IF (@@error!=0)
   		BEGIN
			set @ingproc_001=1
			RAISERROR 20000 'Error insertando Familia'
			ROLLBACK  TRAN
     			RETURN(1)
	    	END



	


FINAL:
	COMMIT TRAN

END