USE [MARKET]
GO
/****** Object:  StoredProcedure [dbo].[IMP_X_RESUMEN]    Script Date: 03/11/2018 16:50:24 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[IMP_X_RESUMEN_V2]
@FECHA SMALLDATETIME,@COD_USER VARCHAR(10),@TURNO INT
AS


SELECT     COUNT(dbo.VENTACAB.NRODOCU) AS CANT, MIN(dbo.VENTACAB.NRODOCU) AS MINIMO, MAX(dbo.VENTACAB.NRODOCU) AS MAXIMO, 
                      SUM(CASE WHEN STAT_VENTA = 0 THEN SUBTOT_VENTA ELSE 0 END) AS VALOR, SUM(CASE WHEN STAT_VENTA = 0 THEN IGV_VENTA ELSE 0 END) 
                      AS IGV, SUM(CASE WHEN STAT_VENTA = 0 THEN TOTAL_VENTA ELSE 0 END) AS TOTAL, 
                      SUM(CASE WHEN STAT_VENTA = 1 THEN STAT_VENTA ELSE 0 END) AS ANULADOS, 
                      SUM(CASE WHEN STAT_VENTA = 1 THEN TOTAL_VENTA ELSE 0 END) AS TOTAL_ANUL, dbo.PTOVTA.APTOCODI,
		SUM(CASE WHEN STAT_VENTA = 0 THEN dbo.VENTACAB.PAGOS_VENTA ELSE 0 END) AS PAGOS, 
		SUM(CASE WHEN STAT_VENTA = 0 THEN dbo.VENTACAB.PAGOD_VENTA ELSE 0 END) AS PAGOD, 
	SUM(CASE WHEN STAT_VENTA = 0 THEN dbo.VENTACAB.VUELTO_VENTA ELSE 0 END) AS VUELTO, 
SUM(CASE WHEN STAT_VENTA=1 THEN 0 ELSE (CASE WHEN CDTIPOPAGO='C' THEN TOTAL_VENTA ELSE 0 END) END ) AS CREDITO

FROM         dbo.VENTACAB LEFT OUTER JOIN
                      dbo.PTOVTA ON dbo.VENTACAB.NROPTOVTA = dbo.PTOVTA.APTOTERM
GROUP BY dbo.VENTACAB.TURNO, dbo.VENTACAB.FECPROCESO, dbo.VENTACAB.NROPTOVTA, dbo.PTOVTA.APTOCODI,VENTACAB.COD_USER
HAVING      (TURNO = @TURNO) AND (FECPROCESO = @FECHA) AND (VENTACAB.COD_USER = @COD_USER)