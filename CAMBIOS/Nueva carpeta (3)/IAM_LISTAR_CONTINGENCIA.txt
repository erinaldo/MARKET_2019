USE MARKET_CELESTE
GO
/****** Object:  StoredProcedure [dbo].[IAM_LISTAR_CONTINGENCIA]    Script Date: 09/05/2019 15:06:12 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[IAM_LISTAR_CONTINGENCIA]
@FI CHAR(8),@FF CHAR(8),
@CADENA VARCHAR(MAX),@FORMA CHAR(1)

AS

declare @CAD VARCHAR(MAX)

IF @FORMA='R'
	BEGIN
		SET @CAD="SELECT VENTAS_MANUAL.ID_VENTASM AS Id, TIPO_DOC.DESC_DOC AS TDocumento, VENTAS_MANUAL.SERIE_VENTASM AS Serie, "+
		" VENTAS_MANUAL.NUMERO_VENTASM AS Numero,VENTAS_MANUAL.FECHA_VENTASM AS Fecha, CLIENTES.RUC_CLIENTE AS Ruc, "+
		" CLIENTES.DESC_CLIENTE AS Cliente, MOTIVO_CONTINGENCIA.DESC_MCONTINGENCIA AS Motivo, "+
        " VENTAS_MANUAL.SUBTOTAL_VENTASM AS SubTotal, VENTAS_MANUAL.IGV_VENTASM AS Igv, VENTAS_MANUAL.TOTAL_VENTASM AS Total, "+
        " CASE WHEN VENTAS_MANUAL.STAT_VENTASM = 0 THEN '' ELSE 'ANULADO' END AS Estado, VENTAS_MANUAL.FECHA_REG AS Registro, "+
        " VENTAS_MANUAL.COD_USER AS Usuario,ISNULL(VENTAS_MANUAL.FELECTRONICA, 0) AS Felectronica "+
		" FROM VENTAS_MANUAL INNER JOIN TIPO_DOC ON VENTAS_MANUAL.COD_DOC = TIPO_DOC.COD_DOC INNER JOIN "+
        " MOTIVO_CONTINGENCIA ON VENTAS_MANUAL.COD_MCONTINGENCIA = MOTIVO_CONTINGENCIA.COD_MCONTINGENCIA LEFT OUTER JOIN "+
        " CLIENTES ON VENTAS_MANUAL.COD_CLIENTE = CLIENTES.COD_CLIENTE "+
		" WHERE (FECHA_VENTASM BETWEEN '"+@FI+"' AND '"+@FF+"')"
	END
	
IF @FORMA='D'
	BEGIN
		SET @CAD="SELECT VENTAS_MANUAL.ID_VENTASM AS Id, TIPO_DOC.DESC_DOC AS TDocumento, VENTAS_MANUAL.SERIE_VENTASM AS Serie, "+
		" VENTAS_MANUAL.NUMERO_VENTASM AS Numero,VENTAS_MANUAL.FECHA_VENTASM AS Fecha, CLIENTES.RUC_CLIENTE AS Ruc, "+
		" CLIENTES.DESC_CLIENTE AS Cliente, MOTIVO_CONTINGENCIA.DESC_MCONTINGENCIA AS Motivo, "+
        " VENTAS_MANUAL.SUBTOTAL_VENTASM AS SubTotal, VENTAS_MANUAL.IGV_VENTASM AS Igv, VENTAS_MANUAL.TOTAL_VENTASM AS Total, "+
        " CASE WHEN VENTAS_MANUAL.STAT_VENTASM = 0 THEN '' ELSE 'ANULADO' END AS Estado, VENTAS_MANUAL.FECHA_REG AS Registro, "+
        " VENTAS_MANUAL.COD_USER AS Usuario,ISNULL(VENTAS_MANUAL.FELECTRONICA, 0) AS Felectronica, ARTICULOS.DESC_ART AS Articulo, "+
        " VENTASD_MANUAL.CANT_VENTASDM AS Cantidad,VENTASD_MANUAL.PU_VENTASDM AS Pu "+
		" FROM ARTICULOS INNER JOIN VENTAS_MANUAL INNER JOIN TIPO_DOC ON VENTAS_MANUAL.COD_DOC = TIPO_DOC.COD_DOC INNER JOIN "+
        " VENTASD_MANUAL ON VENTAS_MANUAL.ID_VENTASM = VENTASD_MANUAL.ID_VENTASM ON ARTICULOS.COD_ART = VENTASD_MANUAL.COD_ART INNER JOIN "+
        " MOTIVO_CONTINGENCIA ON VENTAS_MANUAL.COD_MCONTINGENCIA = MOTIVO_CONTINGENCIA.COD_MCONTINGENCIA LEFT OUTER JOIN "+
        " CLIENTES ON VENTAS_MANUAL.COD_CLIENTE = CLIENTES.COD_CLIENTE "+
        " WHERE (FECHA_VENTASM BETWEEN '"+@FI+"' AND '"+@FF+"')"
	END		

IF @CADENA<>'' SET @CAD=@CAD+@CADENA

SET @CAD=@CAD+" ORDER BY FECHA_VENTASM"

PRINT @CAD
EXEC(@CAD)

