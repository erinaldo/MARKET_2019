USE [MARKET_CELESTE]
GO

/****** Object:  StoredProcedure [dbo].[GRABAR_CONTINGENCIA]    Script Date: 09/04/2019 15:11:24 ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[GRABAR_CONTINGENCIA]
@ID_VENTASM	bigint,
@COD_DOC	CHAR(3),
@SERIE_VENTASM	char(4),
@NUMERO_VENTASM	char(8),
@FECHA_VENTASM	smalldatetime,
@COD_CLIENTE	CHAR(20),
@PIGV	float,
@SUBTOTAL_VENTASM	float,
@IGV_VENTASM	float,
@TOTAL_VENTASM	float,
@COD_USER	varchar(10),
@COD_MCONTINGENCIA INT,
@CORR_TMP FLOAT,
@TIPO CHAR(1),
@SW INT OUTPUT
AS

BEGIN TRAN

SET @SW=0

DECLARE @COD BIGINT

SET @COD=@ID_VENTASM

IF @TIPO='A'
	BEGIN
		UPDATE VENTAS_MANUAL SET STAT_VENTASM=1 WHERE ID_VENTASM=@ID_VENTASM

		IF @@ERROR!=0
			BEGIN
				SET @SW=1
				ROLLBACK TRAN
				RETURN
			END
		COMMIT TRAN
		RETURN
	END

IF @TIPO='N'
	BEGIN
		--AVERIGUAMOS SI EXISTE
		IF(SELECT COUNT(ID_VENTASM) FROM VENTAS_MANUAL WHERE COD_DOC=@COD_DOC AND SERIE_VENTASM=@SERIE_VENTASM
		AND NUMERO_VENTASM=@NUMERO_VENTASM AND STAT_VENTASM=0)>0
			BEGIN
				SET @SW=2
				ROLLBACK TRAN
				RETURN
			END
		
		--GRABAMOS CABECERA
		INSERT INTO VENTAS_MANUAL(COD_DOC,SERIE_VENTASM,NUMERO_VENTASM,FECHA_VENTASM,
		COD_CLIENTE,PIGV,SUBTOTAL_VENTASM,IGV_VENTASM,TOTAL_VENTASM,
		STAT_VENTASM,FECHA_REG,COD_USER,COD_MCONTINGENCIA)
		VALUES
		(@COD_DOC,@SERIE_VENTASM,@NUMERO_VENTASM,CONVERT(VARCHAR,@FECHA_VENTASM,103),
		@COD_CLIENTE,@PIGV,@SUBTOTAL_VENTASM,@IGV_VENTASM,@TOTAL_VENTASM,
		0,GETDATE(),@COD_USER,@COD_MCONTINGENCIA)
		
		SET @COD=@@IDENTITY

		IF @@ERROR!=0
			BEGIN
				SET @SW=1
				ROLLBACK TRAN
				RETURN
			END
	END
IF @TIPO='M'
	BEGIN
		UPDATE VENTAS_MANUAL SET 
		COD_DOC=@COD_DOC,
		SERIE_VENTASM=@SERIE_VENTASM,
		NUMERO_VENTASM=@NUMERO_VENTASM,
		FECHA_VENTASM=CONVERT(VARCHAR,@FECHA_VENTASM,103),
		COD_CLIENTE=@COD_CLIENTE,
		PIGV=@PIGV,
		SUBTOTAL_VENTASM=@SUBTOTAL_VENTASM,
		IGV_VENTASM=@IGV_VENTASM,
		TOTAL_VENTASM=@TOTAL_VENTASM,
		COD_USER=@COD_USER,
		COD_MCONTINGENCIA=@COD_MCONTINGENCIA
		WHERE
		ID_VENTASM=@ID_VENTASM

		DELETE VENTASD_MANUAL WHERE ID_VENTASM=@ID_VENTASM
		
	END

--GRABAMOS EL DETALLE
INSERT INTO VENTASD_MANUAL(ID_VENTASM,FIL_VENTASM,COD_ART,CANT_VENTASDM,PU_VENTASDM)
SELECT @COD,ITEM,COD_ART,ISNULL(ATMPCANT,0),ATMPPREC
FROM TMP_DETALLE WHERE CORRNBR=@CORR_TMP 
	IF @@ERROR!=0
		BEGIN
			SET @SW=1
			ROLLBACK TRAN
			RETURN
		END


COMMIT TRAN
RETURN



GO


