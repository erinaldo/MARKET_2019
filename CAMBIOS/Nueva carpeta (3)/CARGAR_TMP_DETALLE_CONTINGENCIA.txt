USE MARKET_CELESTE
GO
/****** Object:  StoredProcedure [dbo].[CARGAR_TMP_DETALLE_CONTINGENCIA]    Script Date: 09/05/2019 11:04:49 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE PROCEDURE [dbo].[CARGAR_TMP_DETALLE_CONTINGENCIA]
@CORR_TMP FLOAT,
@ID_VENTASM  BIGINT,
@SW INT OUTPUT

 AS

 BEGIN TRAN	
	SET @SW=0
		
	--*
	DECLARE @FILA BIGINT
	DECLARE @CUR_COD_PROD CHAR(15),@CUR_CANT_OCD FLOAT,@CUR_PU_OCD FLOAT,@CUR_FILA BIGINT
	
	DECLARE CUR Cursor SCROLL For 
		SELECT COD_ART, CANT_VENTASDM, PU_VENTASDM, FIL_VENTASM
		FROM VENTASD_MANUAL
		WHERE ID_VENTASM=@ID_VENTASM
		ORDER BY FIL_VENTASM

	OPEN CUR
	FETCH NEXT FROM CUR INTO @CUR_COD_PROD,@CUR_CANT_OCD,@CUR_PU_OCD,@CUR_FILA
		
	SET @FILA=@CUR_FILA

	WHILE @@FETCH_STATUS =0
		BEGIN
			INSERT INTO TMP_DETALLE(CORRNBR,COD_ART,ATMPCANT,ATMPPREC,ITEM)
			VALUES(@CORR_TMP,@CUR_COD_PROD,@CUR_CANT_OCD,@CUR_PU_OCD,@CUR_FILA)

			FETCH NEXT FROM CUR INTO @CUR_COD_PROD,@CUR_CANT_OCD,@CUR_PU_OCD,@CUR_FILA
		END
	
	close CUR
	deallocate CUR

	IF (@@ERROR!=0)
	    BEGIN
			RAISERROR 2000 'error actualizando datos'
			ROLLBACK TRAN
			SET @SW=1
	        RETURN(1)
	    END

	
    COMMIT TRAN


